<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0 ,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>结算页面</title>
    <!--字体图标-->
    <link href="../javaex/pc/css/icomoon.css" rel="stylesheet" />
    <!--动画-->
    <link href="../javaex/pc/css/animate.css" rel="stylesheet" />
    <!--骨架样式-->
    <link href="../javaex/pc/css/common.css" rel="stylesheet" />
    <!--皮肤（缇娜）-->
    <link href="../javaex/pc/css/skin/tina.css" rel="stylesheet" />
    <!--jquery，不可修改版本-->
    <script src="../javaex/pc/lib/jquery-1.7.2.min.js"></script>
    <!--全局动态修改-->
    <script src="../javaex/pc/js/common.js"></script>
    <!--核心组件-->
    <script src="../javaex/pc/js/javaex.min.js"></script>
    <!--表单验证-->
    <script src="../javaex/pc/js/javaex-formVerify.js"></script>

    <link rel="stylesheet" href="../css/pick-pcc.min.1.0.1.css">
    <link href="../AmazeUI-2.4.2/assets/css/amazeui.css" rel="stylesheet" type="text/css" />

    <link href="../basic/css/demo.css" rel="stylesheet" type="text/css" />
    <link href="../css/cartstyle.css" rel="stylesheet" type="text/css" />

    <link href="../css/jsstyle.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="../js/address.js"></script>

</head>

<body>

    <!--顶部导航条 -->
    <div class="am-container header">
        <ul class="message-l">
            <div class="topMessage">
                <div class="menu-hd" id="loginAndResister">
                    <a href="login.html" target="_top" class="h">亲，请登录</a>
                    <a href="register.html" target="_top">免费注册</a>
                </div>
            </div>
        </ul>
        <ul class="message-r">
            <div class="topMessage home">
                <div class="menu-hd"><a href="index.html" target="_top" class="h">商城首页</a></div>
            </div>
            <div class="topMessage my-shangcheng">
                <div class="menu-hd MyShangcheng"><a id="person" href="/person/information.html" target="_top"><i
                            class="am-icon-user am-icon-fw"></i>个人中心</a></div>
            </div>
            <div class="topMessage mini-cart">
                <div class="menu-hd"><a id="mc-menu-hd" href="shopcart.html" target="_top"><i
                            class="am-icon-shopping-cart  am-icon-fw"></i><span>购物车</a></div>
            </div>


        </ul>
    </div>

    <!--悬浮搜索框-->

    <div class="nav white">


        <p style="background-color: tomato;height: 2px;margin-top: 70px;"></p>

        <div class="clear"></div>
        <div class="concent">
            <!--地址 -->
            <div class="paycont">
                <div class="address">
                    <h3>选择收货地址 </h3>
                    <div class="control">
                        <div class="tc-btn createAddr theme-login am-btn am-btn-danger">使用新地址</div>
                    </div>
                    <div class="clear"></div>
                    <ul id="address">
                        <h2>正在获取信息</h2>
                    </ul>

                    <div class="clear"></div>
                </div>

                <div class="clear"></div>


                <div class="clear"></div>

                <!--订单 -->
                <div class="concent">
                    <div id="payTable">
                        <h3>确认订单信息</h3>
                        <div class="cart-table-th">
                            <div class="wp">

                                <div class="th th-item">
                                    <div class="td-inner">商品信息</div>
                                </div>
                                <div class="th th-price">
                                    <div class="td-inner">单价</div>
                                </div>
                                <div class="th th-amount">
                                    <div class="td-inner">数量</div>
                                </div>
                                <div class="th th-sum">
                                    <div class="td-inner">金额</div>
                                </div>


                            </div>
                        </div>
                        <div class="clear"></div>

                        <tr class="item-list">
                            <div class="bundle  bundle-last">

                                <div class="bundle-main" id="carts">
                                    <h2>正在获取信息</h2>
                                    <div class="clear"></div>

                                </div>
                        </tr>
                        <div class="clear"></div>
                    </div>

                    <tr id="J_BundleList_s_1911116345_1" class="item-list">
                </div>
                <div class="clear"></div>
                <div class="pay-total">



                    <div class="clear"></div>
                </div>


                <!--信息 -->
                <div class="order-go clearfix">
                    <div class="pay-confirm clearfix">
                        <div class="box" id="orderInfo">
                            <div tabindex="0" id="holyshit267" class="realPay"><em class="t">实付款：</em>
                                <span class="price g_price ">
                                    <span>¥</span> <em class="style-large-bold-red " id="J_ActualFee">正在计算...</em>
                                </span>
                            </div>

                            <div id="holyshit268" class="pay-address">

                                <p class="buy-footer-address">
                                    请选择收货地址
                                </p>
                            </div>
                        </div>

                        <div id="holyshit269" class="submitOrder">
                            <div class="go-btn-wrap">
                                <a id="J_Go" onclick="setOrder()" class="btn-go" tabindex="0"
                                    title="点击此按钮，提交订单">提交订单</a>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
            </div>

            <div class="clear"></div>
        </div>
    </div>
    <div class="footer ">
        <div class="footer-hd ">
            <p>
                <a href="#">商城首页</a>
                <b>|</b>
                <a href="#">物流</a>
            </p>
        </div>
        <div class="footer-bd ">
            <p>
                <em>©常州ccit版权所有</em>
            </p>
        </div>
    </div>
    </div>
    <div class="theme-popover-mask"></div>
    <div class="theme-popover">

        <!--标题 -->
        <div class="am-cf am-padding">
            <div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">使用新地址</strong></div>
        </div>
        <hr />

        <div class="am-u-md-12">
            <form class="am-form am-form-horizontal">

                <div class="am-form-group">
                    <label for="user-name" class="am-form-label">收货人</label>
                    <div class="am-form-content">
                        <input type="text" id="user-name" placeholder="收货人" readonly>
                    </div>
                </div>

                <div class="am-form-group">
                    <label for="user-phone" class="am-form-label">手机号码</label>
                    <div class="am-form-content">
                        <input id="user-phone" placeholder="手机号必填" type="email" readonly>
                    </div>
                </div>

                <div class="am-form-group">
                    <label for="user-phone" class="am-form-label">所在地</label>
                    <div style="padding-left: 75px;">
                        <a href="javascript:void(0)" class="pick-area pick-area6" name="" id="user-address"></a>
                    </div>

                </div>

                <div class="am-form-group">
                    <label for="user-intro" class="am-form-label">详细地址</label>
                    <div class="am-form-content">
                        <textarea class="" rows="3" id="user-intro" placeholder="输入详细地址"></textarea>
                        <small>100字以内写出你的详细地址...</small>
                    </div>
                </div>

                <div class="am-form-group theme-poptit">
                    <div class="am-u-sm-9 am-u-sm-push-3">
                        <div class="am-btn am-btn-danger" onclick="addAddress()">保存</div>
                        <div class="am-btn am-btn-danger close">取消</div>
                    </div>
                </div>
            </form>
        </div>

    </div>


    <div class="clear"></div>
</body>
<script>
    var addressList, addressList1, name, user, cartList;
    window.onload = function () {
        // console.log("123");
        user = JSON.parse(sessionStorage.getItem("user"));
        // console.log(user)
        if (user != null) {
            $("#loginAndResister").css("display", "none"); //隐藏div
        } else {
            $("#person").attr("href", "login.html");
            $("#mc-menu-hd").attr("href", "login.html");
        }
        // console.log("userid：" + user.userId)
        $.ajax({
            type: "post",
            //后端需要调用的地址
            url: "http://127.0.0.1:8080/ShopSystem/getAddress",
            dataType: "json",
            data: {
                "userId": user.userId
            },
            // contentType: "json/application",
            //设置超时
            timeout: 10000,
            async: true,
            success: function (response) {
                // console.log(response);
                if (response.code == "SUCCESS") {
                    addressList = JSON.parse(response.addressList)
                    addressList1 = JSON.stringify(addressList)
                    name = response.name

                    var html1 = "";
                    for (var i = 0; i < addressList.length; i++) {
                        var html1 = html1 + createAllAddresses(addressList[i], name, user)
                    }
                    $("#address").html(html1);
                    $("#user-name").val(name);
                    $("#user-phone").val(user.phone);
                    javaex.optTip({
                        content: "信息获取成功",
                        type: "success"
                    });
                }

            },
            error: function (data) {
                javaex.optTip({
                    content: "信息获取失败",
                    type: "error"
                });
            },
            //调用执行后调用的函数
            complete: function (XMLHttpRequest, textStatus) {
                if (textStatus == 'timeout') {
                    uploadAjax.abort(); //取消请求
                    //超时提示：请求超时，请重试
                    javaex.optTip({
                        content: "操作失败",
                        type: "error"
                    });
                    javaex.alert({
                        content: "请求超时，请重试"
                    });
                }
            }
        });
        var selected = sessionStorage.getItem("selected");
        $.ajax({
            type: "post",
            //后端需要调用的地址
            url: "http://127.0.0.1:8080/ShopSystem/getOrders",
            dataType: "json",
            data: {
                "selected": selected
            },
            // contentType: "json/application",
            //设置超时
            timeout: 10000,
            async: true,
            success: function (response) {
                // console.log(response);
                if (response.code == "SUCCESS") {
                    cartList = JSON.parse(response.cartList)
                    var goodsList = JSON.parse(response.goodsList)
                    var html2 = "";
                    for (var i = 0; i < cartList.length; i++) {
                        var html2 = html2 + createAllOrders(cartList[i], goodsList[i])
                    }
                    $("#carts").html(html2);
                    var price = 0;
                    for (var i = 0; i < cartList.length; i++) {
                        price = price + cartList[i].num * goodsList[i].price;
                    }
                    sessionStorage.setItem("price", price)
                    var html3 = "" + createPrice(price);
                    $("#holyshit267").html(html3);
                }

            },
            error: function (data) {
                javaex.optTip({
                    content: "信息获取失败",
                    type: "error"
                });
            }
        });
    }

    function createAllAddresses(address, name, user) {
        return `<li class="user-addresslist">
                            <div class="address-left">
                                <div class="user">
                                    <span class="buy-address-detail DefaultAddr">   
                   					<span class="buy-user">` + name + `</span>
                                    <span class="buy-phone">` + user.phone + `</span>
                                    </span>
                                </div>
                                <div class="default-address DefaultAddr">
                                    <span class="buy-line-title buy-line-title-type">收货地址：</span>
                                    <span class="buy--address-detail">
								    <span class="province">` + address.province + `</span>
                                    <span class="city">` + address.city + `</span>
                                    <span class="dist">` + address.district + `</span><br>
                                    <span class="street">` + address.address + `</span>
                                    </span>

                                    </span>
                                </div>
                            </div>
                           
                            <button class="button wathet" style="margin-top:25px" onclick="chooseThis(` + address.addressId + `)">选择此地址</button>
                            <div class="clear"></div>

                            <div class="new-addr-btn">

                                
                            </div>

                        </li>
                        <div class="per-border"></div>
`
    }

    function createAllOrders(cart, goods) {
        return `<ul class="item-content clearfix">
                                        <div class="pay-phone">
                                            <li class="td td-item">
                                                <div class="item-pic">
                                                    <a href="#" class="J_MakePoint">
                                                        <img style="heigth:80px;width:80px" src="http://localhost:8080/ShopSystem/images/` + goods.imgUrl + `" class="itempic J_ItemImg"></a>
                                                </div>
                                                <div class="item-info">
                                                    <div class="item-basic-info">
                                                        <a href="#" class="item-title J_MakePoint" data-point="tbcart.8.11">` + goods.name + `</a>
                                                    </div>
                                                </div>
                                            </li>
                                            <li class="td td-info">
                                                <div class="item-props">
                                                    <span class="sku-line">` + goods.info + `</span>
                                                </div>
                                            </li>
                                            <li class="td td-price">
                                                <div class="item-price price-promo-promo">
                                                    <div class="price-content">
                                                        <em class="J_Price price-now"> ￥` + goods.price + `</em>
                                                    </div>
                                                </div>
                                            </li>
                                        </div>
                                        <li class="td td-amount">
                                            <div class="amount-wrapper ">
                                                <div class="item-amount ">
                                                    <span class="phone-title">购买数量</span>
                                                    <div class="sl">
                                                        <input class="text_box" name="" type="text" value="` + cart.num + `" style="width:30px;" readonly/>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="td td-sum">
                                            <div class="td-inner">
                                                <em tabindex="0" class="J_ItemSum number"> ￥` + cart.num * goods.price + `</em>
                                            </div>
                                        </li>
                                        <li class="td td-oplist">

                                        </li>

                                    </ul>
                                    <div class="clear"></div>`;
    }

    function createInfo(index, name, user) {
        // console.log(user.phone)
        sessionStorage.setItem("phone", user.phone)
        sessionStorage.setItem("name", name)
        return ` <p class="buy-footer-address">
                                        <span class="buy-line-title buy-line-title-type">寄送至：</span>
                                        <span class="buy--address-detail">
								   <span class="province">` + addressList[index].province + `</span>
                                        <span class="city">` + addressList[index].city + `</span>
                                        <span class="dist">` + addressList[index].district + `</span>
                                        <span class="street">` + addressList[index].address + `</span>
                                        </span>
                                        </span>
                                    </p>
                                    <p class="buy-footer-address">
                                        <span class="buy-line-title">收货人：</span>
                                        <span class="buy-address-detail">   
                                         <span class="buy-user">` + name + `</span>
                                        <span class="buy-phone">` + user.phone + `</span>
                                        </span>
                                    </p>`;
    }

    function createPrice(price) {
        return `<em class="t">实付款：</em>
                                    <span class="price g_price ">
                                    <span>¥</span> <em class="style-large-bold-red " id="J_ActualFee">` + price + `</em>
                                    </span>`;
    }

    function chooseThis(id) {
        // console.log(user)
        // console.log(user.phone)
        for (var i = 0; i < addressList.length; i++) {
            // console.log(addressList[i])
            if (addressList[i].addressId == id) {
                // console.log("选择了这个收货地址" + addressList[i])
                sessionStorage.setItem("addressId", id)
                sessionStorage.setItem("chooseAddress", JSON.stringify(addressList[i]));
                var html4 = "" + createInfo(i, name, user);
                $("#holyshit268").html(html4)
            }
        }


    }

    function reload() {
        window.location.reload(true);
    }

    function addAddress() {
        var address1 = $(".pick-area-hidden").val();
        var address2 = $("#user-intro").val();

        console.log(address1)
        console.log(address2)

        if (address1 == "" || address2 == "") {
            alert("请选择你的收货地址，不能为空哦");


        } else {
            javaex.optTip({
                content: "数据提交中，请稍候...",
                type: "submit"
            });
            $.ajax({
                type: "post",
                //后端需要调用的地址
                url: "http://127.0.0.1:8080/ShopSystem/addAddress",
                dataType: "json",
                data: {
                    "userId": user.userId,
                    "address1": $(".pick-area-hidden").val(),
                    "address2": address2
                },
                // contentType: "json/application",
                //设置超时
                timeout: 10000,
                async: true,
                success: function (response) {
                    // console.log(response);
                    if (response.code == "SUCCESS") {
                        javaex.optTip({
                            content: "操作成功",
                            type: "success"
                        });

                        javaex.alert({
                            content: "添加成功，请选择收货地址吧"
                        });
                        reload();

                    }
                },
                error: function (data) {
                    javaex.optTip({
                        content: "操作失败",
                        type: "error"
                    });
                }
            });


        }





    }

    function toSuccess() {
        window.location.href = "success.html";
    }

    function setOrder() {

        var addressId = sessionStorage.getItem("addressId");
        var cartsId = sessionStorage.getItem("selected");
        var userId = user.userId;
        javaex.optTip({
            content: "数据提交中，请稍候...",
            type: "submit"
        });
        $.ajax({
            type: "post",
            //后端需要调用的地址
            url: "http://127.0.0.1:8080/ShopSystem/pushOrders",
            dataType: "json",
            data: {
                "addressId": addressId,
                "cartIds": cartsId
            },
            // contentType: "json/application",
            //设置超时
            timeout: 10000,
            async: true,
            success: function (response) {
                // console.log(response);
                if (response == "SUCCESS") {
                    javaex.optTip({
                        content: "操作成功",
                        type: "success"
                    });
                    toSuccess();
                } else {
                    javaex.message({
                        content: "操作失败",
                        type: "error"
                    });
                    javaex.alert({
                        content: "下单晚啦，库存不足了"
                    });
                }

            },
            error: function (data) {
                javaex.optTip({
                    content: "操作失败",
                    type: "error"
                });
            },
            //调用执行后调用的函数
            complete: function (XMLHttpRequest, textStatus) {
                if (textStatus == 'timeout') {
                    uploadAjax.abort(); //取消请求
                    //超时提示：请求超时，请重试
                    javaex.optTip({
                        content: "操作失败",
                        type: "error"
                    });
                    javaex.alert({
                        content: "请求超时，请重试"
                    });
                }
            }
        });
    }
</script>
<script type="text/javascript" src="/js/pick-pcc.min.1.0.1.js"></script>
<script type="text/javascript">
    $(".pick-area6").pickArea({
        "format": "请选择省/请选择市/请选择区", //格式
        "width": "380",
        "borderColor": "#CCCCCC", //文本边框的色值
        "arrowColor": "#CCCCCC", //下拉箭头颜色
        "listBdColor": "#CCCCCC", //下拉框父元素ul的border色值
        "color": "#9999A6", //字体颜色
        "hoverColor": "#D83832",
        //"preSet":"山东省/临沂市/兰陵县",
        "getVal": function () {
            console.log($(".pick-area-hidden").val())
            console.log($(".pick-area-dom").val())
            // var thisdom = $("." + $(".pick-area-dom").val());
            // thisdom.next().val($(".pick-area-hidden").val());
        }
    });
</script>

</html>